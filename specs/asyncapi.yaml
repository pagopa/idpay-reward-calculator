asyncapi: 2.0.0
info:
  title: Reward Calculator Service
  version: 1.0.0
  description: >-
    Its purpose is to notify allowed citizen notification and cancellation of an initiative
tags:
  - name: "trxProcessor"
    description: "capture rtd transactions"
  - name: "trxProcessorOut"
    description: "returns the result of the transaction evaluation"
  - name: "rewardRuleConsumer"
    description: "captures the initiative creation event"
  - name: "hpanInitiativeConsumer"
    description: "Captures the payment instrument number"
  - name: "hpanUpdateOutcome"
    description: "Returns the status after registering the payment instruments"
  - name: "trxResubmitter"
    description: "Reevaluate chargeback transactions that arrived before debit transactions"
  - name: "trxResponseConsumer"
    description: "Retrieve the publication from Payment to unlock the counter"
  - name: "deleteInitiative"
    description: "Delete the initiative"
channels:
  reward-calculator-trx-processor:
    subscribe:
      message:
        $ref: '#/components/messages/RewardTransactionEvaluationError'
      bindings:
        kafka:
          topic: idpay-transaction-user-id-splitter
      tags:
        - name: "trxProcessor"
  reward-calculator-trx-processor-out:
    publish:
      message:
        $ref: '#/components/messages/RewardTransactionNotifyError'
      bindings:
        kafka:
          topic: idpay-transaction
      tags:
        - name: "trxProcessorOut"
  reward-calculator-reward-rule-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/RewardRuleBuilderError'
      bindings:
        kafka:
          topic: idpay-rule-update
      tags:
        - name: "rewardRuleConsumer"
  reward-calculator-hpan-initiative-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/HpanUpdateEvaluationError'
      bindings:
        kafka:
          topic: idpay-hpan-update
      tags:
        - name: "hpanInitiativeConsumer"
  reward-calculator-hpan-update-outcome:
    publish:
      message:
        $ref: '#/components/messages/HpanInitiativeExecutionError'
      bindings:
        kafka:
          topic: idpay-hpan-update-outcome
      tags:
        - name: "hpanUpdateOutcome"
  reward-calculator-trx-resubmitter:
    publish:
      message:
        $ref: '#/components/messages/TrxResubmitterError'
      bindings:
        kafka:
          topic: idpay-transaction-user-id-splitter
      tags:
        - name: "trxResubmitter"
  reward-calculator-trx-response-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/UserCounterUnlockEvaluationError'
      bindings:
        kafka:
          topic: idpay-transaction
      tags:
        - name: "trxResponseConsumer"
  group-delete-initiative:
    subscribe:
      message:
        $ref: '#/components/messages/QueueCommandOperationDTO'
      bindings:
        kafka:
          topic: idpay-commands
      tags:
        - name: "deleteInitiative"
components:
  messages:
    RewardRuleBuilderError:
      contentType: application/json
      description: >-
        An error occurred during the handling of the reward rule builder initiative
      summary: Informs of reward rule builder error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RewardTransactionEvaluationError:
      contentType: application/json
      description: >-
        An error occurred during the evaluation of the reward transaction
      summary: Informs of reward transaction evaluation error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RewardTransactionNotifyError:
      contentType: application/json
      description: >-
        An error occurred during the notification of the reward transaction
      summary: Informs of reward transaction notification error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    HpanUpdateEvaluationError:
      contentType: application/json
      description: >-
        An error occurred during the evaluation of the HPAN update initiative
      summary: Informs of HPAN update evaluation error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    HpanInitiativeExecutionError:
      contentType: application/json
      description: >-
        An error occurred during the execution of the HPAN initiative
      summary: Informs of HPAN initiative execution error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    TrxResubmitterError:
      contentType: application/json
      description: >-
        Rivaluta le transazioni di storno arrivate prima di quelle dell'addebito
      summary: Rivaluta transazioni di storno
      headers:
        type: object
        properties:
          key:
            type: string
            description: "user id"
            example: "bcf3651c-d2d3-4998-81a9-5f24302ab674"
      payload:
        $ref: "#/components/schemas/TransactionDTO"
    UserCounterUnlockEvaluationError:
      contentType: application/json
      description: >-
        An error occurred during the evaluation of the user counter unlock transaction
      summary: Informs of user counter unlock evaluation error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    QueueCommandOperationDTO:
      contentType: application/json
      description: >-
        Event consumed from application when a delete initiative command has published
      summary: Delete documents of the initiative
      payload:
        $ref: "#/components/schemas/QueueCommandOperationDTO"


  schemas:
    Reward:
      type: object
      properties:
        initiativeId:
          type: string
          description: Id of the initiative
          example: 661626073785876cb5aa7601
        organizationId:
          type: string
          description: Identifier of the organization associated with the initiative
          example: c326cac6-a38c-416c-a3c3-f6a407b77950
        providedRewardCents:
          type: integer
          format: int64
          description: reward calculated by rule engine
          example: 30000
        accruedRewardCents:
          type: integer
          format: int64
          description: reward updated after evaluation of any limits (budget, ecc...)
          example: 30000
        capped:
          type: boolean
          description: If the premium has been limited due to the beneficiary's budget
          example: false
        dailyCapped:
          type: boolean
          description: If the premium has been reached, it causes a daily limit
          example: false
        monthlyCapped:
          type: boolean
          description: If the premium has been reached, it causes a monthly limit
          example: false
        yearlyCapped:
          type: boolean
          description: If the premium has been reached, it causes an annual limit
          example: false
        weeklyCapped:
          type: boolean
          description: If the premium has been reached due to weekly limit
          example: false
        refund:
          type: boolean
          description: If the user has been refunded
          example: false
        completeRefund:
          type: boolean
          description: If the user has been fully refunded
          example: false
        counters:
          $ref: "#/components/schemas/Counter"

    Counter:
      type: object
      properties:
        trxNumber:
          type: integer
          format: int64
          description: transaction number
          example: 1
        totalRewardCents:
          type: integer
          format: int64
          description: total reward
          example: 30000
        totalAmountCents:
          type: integer
          format: int64
          description: total amount
          example: 900000
        exhaustedBudget:
          type: boolean
          description: if the budget is exhausted
        initiativeBudgetCents:
          type: integer
          format: int64
          description: initiative budget
          example: 30000
        version:
          type: integer
          format: int64
          description: sequence operation number
          example: 1

    TransactionDTO:
      type: object
      properties:
        idTrxAcquirer:
          type: string
          description: ID of the transaction from the acquirer
        acquirerCode:
          type: string
          description: Code of the acquirer
        trxDate:
          type: string
          format: date-time
          description: Date and time of the transaction
        hpan:
          type: string
          description: HPAN (Hashed PAN)
        operationType:
          type: string
          description: Type of operation
        circuitType:
          type: string
          description: Type of circuit
        idTrxIssuer:
          type: string
          description: ID of the transaction issuer
        correlationId:
          type: string
          description: Correlation ID
        amount:
          type: number
          description: Amount of the transaction
        amountCurrency:
          type: string
          description: Currency of the transaction amount
        mcc:
          type: string
          description: Merchant Category Code
        acquirerId:
          type: string
          description: ID of the acquirer
        merchantId:
          type: string
          description: ID of the merchant
        terminalId:
          type: string
          description: ID of the terminal
        bin:
          type: string
          description: Bank Identification Number
        senderCode:
          type: string
          description: Sender code
        fiscalCode:
          type: string
          description: Fiscal code
        vat:
          type: string
          description: VAT (Value Added Tax) number
        posType:
          type: string
          description: Type of point of sale
        par:
          type: string
          description: PAR (Parameter) value
        id:
          type: string
          description: ID of the transaction
        operationTypeTranscoded:
          type: string
          description: Transcoded type of operation
        rejectionReasons:
          type: array
          items:
            type: string
          description: List of rejection reasons
        amountCents:
          type: integer
          description: Amount of the transaction in cents
        effectiveAmountCents:
          type: integer
          description: Effective amount of the transaction in cents
        trxChargeDate:
          type: string
          format: date-time
          description: Date and time of the transaction charge
        refundInfo:
          $ref: "#/components/schemas/RefundInfo"
          description: Information about refund
        channel:
          type: string
          description: Channel of the transaction
        ruleEngineTopicPartition:
          type: integer
          description: Partition of the rule engine topic
        ruleEngineTopicOffset:
          type: integer
          description: Offset of the rule engine topic
        userId:
          type: string
          description: User ID
        brandLogo:
          type: string
          description: Brand logo
        brand:
          type: string
          description: Brand
        maskedPan:
          type: string
          description: Masked PAN
    TransactionProcessed:
      type: object
      properties:
        id:
          type: string
          description: ID of the transaction
        idTrxAcquirer:
          type: string
          description: ID of the transaction from the acquirer
        acquirerCode:
          type: string
          description: Code of the acquirer
        trxDate:
          type: string
          format: date-time
          description: Date and time of the transaction
        operationType:
          type: string
          description: Type of operation
        acquirerId:
          type: string
          description: ID of the acquirer
        userId:
          type: string
          description: User ID
        correlationId:
          type: string
          description: Correlation ID
        amount:
          type: number
          description: Amount of the transaction
        rewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Reward"
          description: Map of rewards
        status:
          type: string
          description: Status of the transaction
        rejectionReasons:
          type: array
          items:
            type: string
          description: List of rejection reasons
        initiativeRejectionReasons:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of initiative rejection reasons
        refundInfo:
          $ref: "#/components/schemas/RefundInfo"
          description: Information about refund
        initiatives:
          type: array
          items:
            type: string
          description: List of initiatives
        effectiveAmountCents:
          type: integer
          description: Effective amount of the transaction in cents
        amountCents:
          type: integer
          description: Amount of the transaction in cents
        trxChargeDate:
          type: string
          format: date-time
          description: Date and time of the transaction charge
        operationTypeTranscoded:
          type: string
          description: Transcoded type of operation
        elaborationDateTime:
          type: string
          format: date-time
          description: Date and time of transaction elaboration
        channel:
          type: string
          description: Channel of the transaction
        ruleEngineTopicPartition:
          type: integer
          description: Partition of the rule engine topic
        ruleEngineTopicOffset:
          type: integer
          description: Offset of the rule engine topic
    RefundInfo:
      type: object
      properties:
        previousTrxs:
          type: array
          items:
            $ref: "#/components/schemas/TransactionProcessed"
          description: List of previous transactions
        previousRewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/RefundInfo.PreviousReward"
          description: Map of previous rewards
    RefundInfo.PreviousReward:
      type: object
      properties:
        initiativeId:
          type: string
          description: ID of the initiative
        organizationId:
          type: string
          description: ID of the organization
        accruedRewardCents:
          type: integer
          description: Accrued reward in cents

    InitiativeReward2BuildDTO:
      type: object
      properties:
        initiativeId:
          type: string
          description: Constant that define operation type
          example: DELETE_INITIATIVE
        initiativeName:
          type: string
          description: The name of the initiative
          example: "initiativeTest"
        organizationId:
          type: string
          description: The id of the organization
          example: ""
        general:
          $ref: "#/components/schemas/InitiativeGeneralDTO"
        rewardRule:
          $ref: "#/components/schemas/InitiativeRewardRule"
        trxRule:
          $ref: "#/components/schemas/InitiativeTrxConditions"
        initiativeRewardType:
          $ref: "#/components/schemas/InitiativeRewardType"
    HpanInitiativeBulkDTO:
      type: object
      properties:
        userId:
          type: string
          description: User ID
        initiativeId:
          type: string
          description: Initiative ID
        infoList:
          type: array
          items:
            $ref: "#/components/schemas/PaymentMethodInfoDTO"
          description: List of payment method information
        operationType:
          type: string
          description: Type of operation
        operationDate:
          type: string
          format: date-time
          description: Date and time of the operation
        channel:
          type: string
          description: Channel of the operation
    HpanUpdateOutcomeDTO:
      type: object
      properties:
        initiativeId:
          type: string
          description: Initiative ID
        userId:
          type: string
          description: User ID
        hpanList:
          type: array
          items:
            type: string
          description: List of HPANs (Hashed PANs)
        rejectedHpanList:
          type: array
          items:
            type: string
          description: List of rejected HPANs
        operationType:
          type: string
          description: Type of operation
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the operation
    RewardTransactionDTO:
      allOf:
        - $ref: "#/components/schemas/TransactionDTO"
      type: object
      properties:
        status:
          type: string
          description: Transaction status
        initiativeRejectionReasons:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of initiative rejection reasons
        rewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Reward"
          description: Map of rewards
        initiatives:
          type: array
          items:
            type: string
          description: List of initiatives
        elaborationDateTime:
          type: string
          format: date-time
          description: Date and time of transaction elaboration
    PaymentMethodInfoDTO:
      type: object
      properties:
        hpan:
          type: string
          description: HPAN (Hashed PAN)
        maskedPan:
          type: string
          description: Masked PAN
        brandLogo:
          type: string
          description: Brand logo
        brand:
          type: string
          description: Brand
    InitiativeGeneralDTO:
      type: object
      properties:
        name:
          type: string
          description: Name of the initiative
        budgetCents:
          type: integer
          description: Budget of the initiative in cents
          example: 5000000
        beneficiaryType:
          type: string
          enum:
            - PF
            - PG
            - NF
          description: Type of beneficiary of the initiative
        beneficiaryKnown:
          type: boolean
          description: Indicates whether the beneficiary is known
          example: true
        beneficiaryBudgetCents:
          type: integer
          description: Budget of the beneficiary in cents
          example: 2000000
        startDate:
          type: string
          format: date
          description: Start date of the initiative
          example: "2024-05-01"
        endDate:
          type: string
          format: date
          description: End date of the initiative
          example: "2024-12-31"
        rankingStartDate:
          type: string
          format: date
          description: Start date of the ranking
          example: "2024-06-01"
        rankingEndDate:
          type: string
          format: date
          description: End date of the ranking
          example: "2024-06-30"
    InitiativeRewardRule:
      oneOf:
        - $ref: '#/components/schemas/RewardGroupsDTO'
        - $ref: '#/components/schemas/RewardValueDTO'
    RewardGroupsDTO:
      type: object
      description: DTO to define reward rule groups
      properties:
        rewardGroups:
          type: array
          description: List of reward rule groups
          items:
            $ref: '#/components/schemas/RewardGroupDTO'
    RewardGroupDTO:
      allOf:
        - $ref: '#/components/schemas/BaseRewardValue'
      type: object
      description: DTO for a single reward rule group
      properties:
        fromCents:
          type: integer
          description: Minimum value in cents
          example: 100
        toCents:
          type: integer
          description: Maximum value in cents
          example: 1000
        rewardValue:
          type: number
          description: Reward value
          example: 10
        rewardValueType:
          type: string
          description: Type of reward value
          example: PERCENTAGE
    RewardValueDTO:
      type: object
      description: DTO for a single reward value
      allOf:
        - $ref: '#/components/schemas/BaseRewardValue'
      properties:
        rewardValue:
          type: number
          description: Reward value
          example: 10
    BaseRewardValue:
      type: object
      description: Base class for reward value
      properties:
        rewardValue:
          type: number
          description: Reward value
          example: 10
        rewardValueType:
          type: string
          description: Type of reward value
          $ref: '#/components/schemas/RewardValueType'
    RewardValueType:
      type: string
      description: Indicates if the reward represents a fixed value or a percentage
      enum:
        - PERCENTAGE
        - ABSOLUTE
      example: PERCENTAGE
    InitiativeTrxConditions:
      type: object
      properties:
        daysOfWeek:
          $ref: "#/components/schemas/DayOfWeekDTO"
          description: Days of the week
        threshold:
          $ref: "#/components/schemas/ThresholdDTO"
          description: Threshold for transactions
        mccFilter:
          $ref: "#/components/schemas/MccFilterDTO"
          description: Merchant Category Code filter
        trxCount:
          $ref: "#/components/schemas/TrxCountDTO"
          description: Transaction count
        rewardLimits:
          type: array
          items:
            $ref: "#/components/schemas/RewardLimitsDTO"
          description: List of reward limits
    DayOfWeekDTO:
      type: array
      items:
        $ref: "#/components/schemas/DayOfWeekDTO.DayConfig"
      description: List of day configurations
    DayOfWeekDTO.DayConfig:
      type: object
      properties:
        daysOfWeek:
          type: array
          items:
            type: string
            enum: [ MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY ]
          description: Days of the week
        intervals:
          type: array
          items:
            $ref: "#/components/schemas/DayOfWeekDTO.Interval"
          description: List of intervals
    DayOfWeekDTO.Interval:
      type: object
      properties:
        startTime:
          type: string
          format: time
          description: Start time of the interval
        endTime:
          type: string
          format: time
          description: End time of the interval
    ThresholdDTO:
      type: object
      properties:
        fromCents:
          type: integer
          description: Minimum threshold in cents
        fromIncluded:
          type: boolean
          description: Indicates if the minimum threshold is inclusive
        toCents:
          type: integer
          description: Maximum threshold in cents
        toIncluded:
          type: boolean
          description: Indicates if the maximum threshold is inclusive
    MccFilterDTO:
      type: object
      properties:
        allowedList:
          type: boolean
          description: Indicates if the MCC filter represents an allowed list
        values:
          type: array
          items:
            type: string
          description: Set of MCC values
    TrxCountDTO:
      type: object
      properties:
        from:
          type: integer
          description: Minimum transaction count
        fromIncluded:
          type: boolean
          description: Indicates if the minimum transaction count is inclusive
        to:
          type: integer
          description: Maximum transaction count
        toIncluded:
          type: boolean
          description: Indicates if the maximum transaction count is inclusive
    RewardLimitsDTO:
      type: object
      properties:
        frequency:
          type: string
          enum: [ DAILY, WEEKLY, MONTHLY, YEARLY ]
          description: Frequency of reward limit
        rewardLimitCents:
          type: integer
          description: Reward limit in cents
    InitiativeRewardType:
      type: string
      enum: [ DISCOUNT, REFUND ]
      description: Type of initiative reward
    QueueCommandOperationDTO:
      type: object
      properties:
        operationType:
          type: string
          description: Constant that define operation type
          example: DELETE_INITIATIVE
        entityId:
          type: string
          description: Entity to be handled with operationType
          example: 661626073785876cb5aa7601
        operationTime:
          type: string
          format: date-time
          description: operation time
          example: "2024-04-11T07:23:08.874869466"
    ErrorQueueHeader:
      type: object
      properties:
        key:
          type: string
          description: "user id"
          example: "bcf3651c-d2d3-4998-81a9-5f24302ab674"
        applicationName:
          type: string
          description: The name of the application that generated the error.
          example: "reward-service"
        group:
          type: string
          description: The Kafka group to which the error message belongs.
          example: "reward-rule-builder"
        srcType:
          type: string
          description: The type of the source of the error message.
          example: "kafka"
        srcServer:
          type: string
          description: The source server of the error message.
          example: "kafka-broker-1.example.com:9092"
        srcTopic:
          type: string
          description: The Kafka topic of the source of the error message.
          example: "reward-rule-builder-topic"
        description:
          type: string
          description: Description of the error.
          example: "An error occurred during the handling of the reward rule builder initiative"
        retryable:
          type: boolean
          description: Indicates whether the error is retryable or not.
        stacktrace:
          type: string
          description: The stack trace of the error.
          example: "RewardRuleBuilderException -> Error occurred during handling of reward rule builder initiative"
        rootCauseClass:
          type: string
          description: Cause of the error.
          example: "com.example.RewardRuleBuilderException"
        rootCauseMessage:
          type: string
          description: Message of the error.
          example: "Error occurred during handling of reward rule builder initiative"